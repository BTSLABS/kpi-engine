<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='style.css') }}">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
          integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <title>CAHI Threshold Automatization | Kpi Profiles</title>
</head>
<body>

<div class="sidebar">
    <div>
        <a href="/">
            <i class="fas fa-server fa-2x"></i>
            <p>Device&nbsp; <br>Management</p>
        </a>
    </div>

    <div>
        <a href="/administration">
            <i class="fas fa-user-cog fa-2x"></i>
            <p>Administration</p>
        </a>
    </div>
</div>

<div class="main-content">
    <div class="site-header">
        <img class="brand-logo" src="{{ url_for('static', filename='bts_logo.png') }}"/>&trade;
    </div>


    <div class="device-tab-path mt-1">
        <a href="{{ url_for('devices') }}">Devices&nbsp;</a> / {{ host_name }}

    </div>


    <div class="device-table-div">
        <div class="device-header">
            {{ host_name }}
        </div>

        {% if submitted_kpi != "0" %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>KPI profile {{submitted_kpi}} updated!</strong> 
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endif %}
        <table class="device-table">
            <thead>
            <tr>
                <th>Kpi Profile</th>
                <th>Kpi Number</th>
                <th>Health Status</th>
                <th>Threshold</th>
                <th></th>
            </tr>
            </thead>
            <tbody>


            {% for row in data.device_kpi_profiles.devices %}
                <tr>

                    {% for profile in row.kpi_device_profiles %}
                        <td>{{ profile.kpi_profile_id }}

                        <td>{{ profile.kpi_refs|length }} <i class="fas fa-info-circle blue" id="info"
                                                             data-toggle="modal"
                                                             data-target="#myModal"
                                                             onclick="showKpi('{{ profile.kpi_profile_id }}')"></i></td>
     
                        <td class="kpiHealth" data-kpi="{{profile.kpi_profile_id}}" data-hostname="{{host_name}}"></td>
                        <td>
                        </td>
                        {% for kpi in profile.kpi_refs %}


                        {% endfor %}
                        </tr>

                    {% endfor %}

            {% endfor %}


            </tbody>
        </table>
    </div>
</div>

<div class="modal" id="myModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Update Thresholds</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                {% for row in data.device_kpi_profiles.devices %}

                    {% for profile in row.kpi_device_profiles %}
                        {% for kpi in profile.kpi_refs %}
                            <form data-kpi="{{ profile.kpi_profile_id }}" data-kpiref="{{kpi.kpi_id}}" class="kpiRef mt-3"
                                  action="{{ url_for('update_device',device_name=row.device_id, kpi_profile_name= profile.kpi_profile_id, kpi_name= kpi.kpi_id ) }}">
                                <span class="py-1"><strong>KPI id: </strong>{{ kpi.kpi_id }}</span> <br>
                                <span class="py-1"><strong>Link: </strong>{{ kpi.link }}</span> <br>
                                <span class="py-1"><strong>State: </strong> {{ kpi.state }}</span><br>
                                <span class="py-1"><strong>Cancade: </strong>{{ kpi.cadence }}</span><br>
                                <span class="py-1"><strong>Kpi Health: </strong> <span class="hStat"></span></span><br>
                                <input class="btn btn-primary mt-2" type="submit" value="Update threshold">
                            </form>
                        {% endfor %}

                    {% endfor %}
                {% endfor %}


            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<script>
    const hostName = '{{host_name}}';
    function showKpi(id) {
        $(".kpiRef").hide();
        $("[data-kpi='" + id + "']").show();
        $(".kpiRef .btn").show();
            var kpiRefs = document.querySelectorAll("[data-kpi='" + id + "']");
            kpiRefs.forEach(kpiRef => {
                if(typeof kpiRef.dataset.kpiref != undefined){
                    $.get(`http://10.20.101.180:5000/${hostName}/${kpiRef.dataset.kpi}/${kpiRef.dataset.kpiref}/health`, function(resp){
                        if(resp == "1"){
                            $(kpiRef).find(".hStat").html(`<i class="fas fa-exclamation-circle red"></i> Update Required`);
                        }else if(resp == "0"){
                            $(kpiRef).find(".hStat").html(`<i class="fas fa-arrow-circle-up green"></i> OK`);
                            $(kpiRef).find(".btn").hide();
                        }
                    })
                    // if(kpiRef.dataset.kpiref == "pulse_cpu_threshold"){
                    //     $(kpiRef).find(".hStat").html(`<i class="fas fa-exclamation-circle red"></i> Update Required`);

                    // } else {
                    //     $(kpiRef).find(".hStat").html(`<i class="fas fa-arrow-circle-up green"></i> OK`);
                    //     $(kpiRef).find(".btn").hide();
                    // }
                }
            })
    }

    $(document).ready(function () {
        $(".kpiRef").hide();
        const kpiHealths = document.querySelectorAll(".kpiHealth");
        if(kpiHealths.length){
            kpiHealths.forEach( singleHealth => {
                $.get(`http://10.20.101.180:5000/${hostName}/${singleHealth.dataset.kpi}/health`, function(resp){
                    if(resp == "1"){
                        $(singleHealth).html(`<i class="fas fa-exclamation-circle red"></i> Update Required`)
                    }else if(resp == "0"){
                        $(singleHealth).html(`<i class="fas fa-arrow-circle-up green"></i> OK`)
                    }
                })
                // if(singleHealth.dataset.kpi == "emre_deneme_6"){
                //     $(singleHealth).html(`<i class="fas fa-exclamation-circle red"></i> Update Required`)
                // }else{
                //     $(singleHealth).html(`<i class="fas fa-arrow-circle-up green"></i> OK`)
                // }
            })
        }
    })
</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script type=text/javascript src="{{ url_for('static',filename='jquery-3.6.0.min.js') }}"></script>
<script type=text/javascript src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>